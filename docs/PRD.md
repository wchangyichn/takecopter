# PRD - TakeCopter 本地故事创作工作台

## 0. 项目介绍

### 0.1 产品定位
- 本地优先的故事创作工作台，核心覆盖：设定管理、AI 引导补全、结构化创作。
- 使用对象：小说/剧本/世界观设计创作者，强调可迭代、可追溯、低打断创作流。

### 0.2 当前范围
- 首页：故事管理、导入导出、模型设置入口。
- 设定页：设定卡创建、关联、AI 引导、属性迭代与摘要迭代。
- 创作页：结构树编辑（EP/Scene/Shot/Take）。

### 0.3 全局设计原则
- 低压力引导：允许“先写一点点”，再渐进补全。
- 类型创建与模板创建分离：类型卡是空白，模板是结构复用。
- 迭代可追溯：属性与摘要支持版本记录、切换、原因重写。
- UI 一致性：颜色、边框、层级、紧凑间距统一。

### 0.4 关联文件
- 应用入口：`apps/desktop/src/App.tsx`
- 数据模型：`apps/desktop/src/types/index.ts`
- 数据持久化：`apps/desktop/src/hooks/useProjectData.ts`

### 0.5 需求沉淀与执行预设
- 所有新增需求（包括临时口头需求）都必须按信息架构写入本 PRD 的对应章节，不允许只记录在提交说明或聊天记录中。
- 所有涉及 UI 的需求与实现，必须使用 `ui-ux-pro-max` 技能进行样式与交互一致性校验，再进入开发与验收。

---

## 1. 首页

### 1.1 功能需求
- 展示故事列表并支持进入故事工作区。
- 支持创建故事、重命名故事、删除故事、导出项目、导入项目。
- 提供故事级操作：打开故事目录、打开数据库、导出单故事。
- 提供项目初始化与重连入口（本地目录模式）。
- 创建新故事时必须先输入名称，不允许直接按默认模板/默认名称创建。
- 删除故事必须走严格二次确认，确认通过后才允许执行删除。

### 1.2 样式与交互需求
- 信息层级清晰：主要动作（创建/进入）优先显示，次级动作折叠在对应区域。
- 操作反馈明确：导入失败、目录打开失败等需弹窗提示。
- 不阻塞用户：目录选择、导入导出等异步操作提供忙碌状态。
- 创建故事流程提供可见 loading，避免首页点击后长时间无反馈。
- 删除故事确认弹窗需清晰提示“不可恢复”，并显示二次确认输入要求。

### 1.3 当前实现映射
- 页面组件：`apps/desktop/src/views/HomeView.tsx`
- 页面样式：`apps/desktop/src/views/HomeView.module.css`
- 故事重命名弹窗：`apps/desktop/src/views/RenameStoryDialog.tsx`
- 故事新建命名弹窗：`apps/desktop/src/views/NewStoryDialog.tsx`
- 故事删除确认弹窗：`apps/desktop/src/views/DeleteStoryDialog.tsx`
- 项目初始化页：`apps/desktop/src/views/ProjectSetupView.tsx`

---

## 2. 设定页

### 2.0 页面目标
- 用卡片化方式管理世界观、角色、地点、物品、事件等设定。
- 提供“创建 -> 关联 -> 补全 -> 迭代”全流程能力。

### 2.0.1 关联文件
- 页面组件：`apps/desktop/src/views/SettingView.tsx`
- 页面样式：`apps/desktop/src/views/SettingView.module.css`
- 模型定义：`apps/desktop/src/types/index.ts`

### 2.1 设定卡片

#### 2.1.1 设定卡片的创建

**功能需求**
- 支持按类型创建空白卡：空白卡、世界观卡、角色卡、地点卡、物品卡、事件卡。
- 类型创建与模板创建严格分离：
  - 类型创建：不预填属性，仅设置类型/分类等最小信息。
  - 模板创建：复用用户保存的结构（字段、分类、标签等）。

**样式与交互需求**
- 类型创建区使用紧凑按钮，不展示冗长说明。
- 模板区保留详细展示（模板来源、字段数量、摘要等）。
- 创建后与左侧分类联动，立即可见新卡。

**当前实现状态**
- 已实现类型创建与模板创建分区。
- 已实现中文化创建文案与中文模型展示文案。

**关联文件**
- `apps/desktop/src/views/SettingView.tsx`
- `apps/desktop/src/views/SettingView.module.css`

#### 2.1.2 设定卡片的关联

**功能需求**
- 支持卡片级关联与字段级关联。
- 关联类型可选：参考、约束、冲突、触发、揭示、归属、因果、回收。
- 关联目标可点击跳转预览，支持删除关联。

**样式与交互需求**
- 关联入口不应遮挡主编辑流，采用展开面板形式。
- 列表显示需紧凑，重点突出“类型 + 目标卡”。

**当前实现状态**
- 已实现卡片级和字段级关联创建、删除、跳转。
- 已实现关联类型下拉选择与中文化展示。

**关联文件**
- `apps/desktop/src/views/SettingView.tsx`
- `apps/desktop/src/views/SettingView.module.css`

### 2.2 设定卡片详情页

#### 2.2.1 版本迭代

**功能需求**
- 每一条“设定”都支持独立迭代：
  - 创建新迭代版本；
  - 查看迭代历史；
  - 展示迭代路径（从旧到新）；
  - 展示版本 diff（至少支持文本增删改高亮）；
  - 切换“当前版本”并支持原因重写。
- 摘要不再单独迭代：
  - 摘要仅跟随整卡迭代的数据源变化；
  - 移除“摘要单独版本链”作为目标形态。
- 整卡迭代定义为“卡片数据源进化”：
  - 每次整卡迭代都对当前整卡进行完整快照并复制为新数据源；
  - 切换整卡迭代即切换数据源；
  - 不同整卡迭代数据源互不影响（隔离编辑）。
- 方案确认：采用 **A 方案** —— 设定迭代在各自整卡数据源内独立维护，不做跨数据源全局合并。

**样式与交互需求**
- 版本列表紧凑，避免大块白色卡片破坏整体视觉。
- 在设定卡内提供醒目的“当前版本切换”控件。
- 当前版本来源与版本标签均需可视化。
- 迭代原因需使用与全局标签体系一致的标签样式展示。
- 设定迭代历史区域需清晰展示“路径 + diff”，并可快速回看。
- 整卡迭代切换需要提供“炫酷但可控”的转场动画（强调卡片进化感）：
  - 推荐时长：220ms ~ 320ms；
  - 优先使用 opacity/transform/blur 组合，避免布局抖动；
  - 支持 `prefers-reduced-motion` 自动降级。
- 中文输入不应卡顿或被输入法频繁打断。

**当前实现状态**
- 现有实现仍以“设定迭代 + 摘要迭代 + 整卡快照切换”的混合模式为主。
- 尚未完成本节目标态重构（数据源隔离、设定路径+diff、摘要并入整卡数据源、整卡切换动画）。
- 本节新增需求为下一阶段迭代重构的强约束。

**关联文件**
- `apps/desktop/src/types/index.ts`
- `apps/desktop/src/views/SettingView.tsx`
- `apps/desktop/src/views/SettingView.module.css`

#### 2.2.2 设定卡 AI 辅助（内部/外部双通道）

**功能需求**
- AI 辅助能力全量覆盖：引导提问、属性补全、摘要生成/重写、审校建议、润色、外部 AI 导入、版本对比。
- AI 操作采用“单入口 + 默认渠道”模型：用户点击同一动作按钮，按默认渠道（内置/外部）执行。
- 外部 AI 辅助必须支持：
  - 根据当前动作与上下文生成提示词（可复制到外部 AI）；
  - 用户粘贴外部 AI 返回的结构化结果（JSON）；
  - 导入后走与内部 AI 完全一致的处理链路（校验 -> 预览 -> 确认 -> 落卡）。
- 所有 AI 建议默认不直接写入卡片，必须经过确认环节。
- 需要支持批量确认（多字段/多建议一次应用）。
- 卡片不是一次性完成：需支持“增量迭代式 AI 辅助”，允许多轮小步更新。

**上下文与一致性要求**
- AI 生成提示词时必须注入依赖卡片上下文，保证设定一致性。
- 依赖上下文至少包含：依赖卡标题、摘要、关键属性、关联类型。
- 当依赖上下文过长时，按优先级裁剪：强依赖 > 同类型依赖 > 弱依赖，并保留裁剪提示。
- 启用术语表与文风约束，避免角色口吻、世界观规则前后漂移。

**模型与执行策略**
- 启用双层模型策略：默认快模型生成草稿，支持一键切换强模型精修。
- 所有 AI 输出统一转换为结构化 patch，再进入确认应用流程。
- 外部导入结果必须通过 schema 校验；校验失败进入修复流程，不允许直接落库。

**样式与交互需求**
- 默认渠道状态需要在关键 AI 弹窗中醒目展示，并支持就地切换。
- 工程重新打开后需恢复用户上次选择的 AI 渠道（内置/外部）。
- “分步设定引导”升级为“辅助建卡”，并将外部辅助入口合并到展开页面中。
- 建议面板需展示差异内容与影响字段，支持单条确认、全选确认、批量应用。
- 批量确认场景下，若同字段存在冲突建议，只允许保留一个候选并给出明确提示。
- 所有 AI 写入动作均需可追溯（来源、模型、时间、操作人）并可回退。
- 增加整卡迭代功能：支持整卡快照、版本标签、迭代原因与一键设为当前版本。

**当前实现状态**
- 已实现内部 AI 的多项能力基础链路（引导、补全、摘要、审校、润色与落卡确认）。
- 已支持外部 AI 响应导入的基础流程（按模式解析）。
- 已支持按按钮合并显示内部/外部辅助入口，默认渠道可持久化恢复。
- 已支持整卡迭代工坊（创建快照、抽屉查看、设为当前）。

**关联文件**
- `apps/desktop/src/views/SettingView.tsx`
- `apps/desktop/src/views/SettingView.module.css`
- `apps/desktop/src/types/index.ts`
- `apps/desktop/src/hooks/useProjectData.ts`
- 技术任务拆解：`docs/plans/2026-02-21-setting-ai-assist-implementation-breakdown.md`

#### 2.2.3 设定编辑页信息架构与属性编辑体验

**功能需求**
- AI 模型选择需要记忆：用户下次打开设定编辑页时，默认选中上次使用模型。
- 默认渠道（内置/外部）与 AI 选择入口保持近邻，不得在交互上分散过远。
- 完全删除“设为默认依赖卡”功能：
  - 不再支持按类型批量默认依赖设置；
  - 不再支持在单卡详情中将当前卡片设为默认依赖来源；
  - 新建卡片时不再自动挂载默认依赖关系。
- 标签改为“小加号 + 弹窗”流程，且标签展示在名称下方：
  - 在名称字段下方展示当前标签；
  - 在已有标签右侧展示小加号入口；
  - 点击小加号后通过弹窗添加标签（可选已有标签或创建后添加）。
- 整卡迭代改为“按钮触发弹窗”流程：
  - 页面不再常驻整卡迭代大区块；
  - 通过“当前迭代”按钮打开迭代历史弹窗；
  - 弹窗中展示历史与当前迭代的整卡预览（名称、分类、摘要、自定义属性）；
  - 默认版本标签为“原始”，支持迭代名称重命名与设为当前版本。
- 卡片依赖区改为横向依赖标签展示；点击标签可进入依赖编辑流；无依赖时显示“无依赖”。
- 自定义属性创建仅保留一个“添加属性”按钮，新增后可直接编辑；属性名称不可为空；点击右下角“保存”后生效，点击“取消”则关闭编辑并回退未保存改动。
- 预览窗口标题支持直接点击编辑，避免额外“重命名”弹窗打断。
- 属性预览列表仅展示设定名称；点击条目后弹出设定详情预览弹窗（不跳转编辑页）。

**样式与交互需求**
- 编辑区层级清晰：关键信息（名称/分类/依赖）在视觉上先于 AI 与内容区出现。
- 依赖标签横向布局支持溢出滚动，避免挤压信息。
- 标签添加弹窗需保持轻量，不遮挡编辑上下文；支持键盘回车快速提交。
- 整卡迭代历史弹窗需支持快速浏览与当前版本切换，不要求离开当前编辑页。
- 属性编辑区提供明确的“保存/取消”收口操作，避免隐式自动提交造成误操作。
- 预览窗口中的“删除卡片”按钮固定在内容区右下角，降低误触风险。
- 预览窗口滚动容器统一使用全局滚动条样式，保持主题一致性。

**当前实现状态**
- 已实现 AI 模型选择持久化（本地存储）并在页面重开后自动恢复。
- 已收敛 AI 控件区域，使默认渠道与模型选择/AI操作保持紧邻。
- 已删除默认依赖设置与“设为默认依赖卡”入口，新建卡不再自动关联默认依赖。
- 已将标签改为“名称下方展示 + 小加号打开弹窗添加”。
- 已将整卡迭代入口改为按钮触发弹窗，并支持历史预览、重命名、设为当前版本。
- 已将依赖展示改为横向标签+编辑入口，支持无依赖空态文案。
- 已将自定义属性改为“添加属性 + 编辑区保存/取消”流程，并增加名称非空校验。
- 已移除新卡命名前缀耦合逻辑（不再默认使用“地点卡/角色卡”等前缀）。
- 已支持预览标题直改、属性名列表化展示与“点击属性弹窗看详情”。
- 已将预览区删除按钮放置在右下角，并应用全局滚动条样式。

**关联文件**
- `apps/desktop/src/views/SettingView.tsx`
- `apps/desktop/src/views/SettingView.module.css`
- `docs/PRD.md`

---

## 附录 A：非功能需求（当前阶段）
- 可维护性：核心逻辑集中在视图层，后续建议逐步拆分为 hooks/service。
- 稳定性：所有关键流程需通过 `npm run lint` 与 `npm run build`。
- 本地优先：核心数据持久化以本地仓储为主，避免依赖在线服务。

## 附录 B：后续建议
- 增加“版本对比视图”（当前版本 vs 指定版本差异高亮）。
- 增加“按章节/剧情节点筛选迭代”能力，接入大纲页锚点。
- 增加“版本命名建议器”（自动建议 v1/v2，不强制）。
